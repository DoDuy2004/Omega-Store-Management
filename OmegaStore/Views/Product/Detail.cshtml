@model OmegaStore.Models.Review

@{
    ViewData["Title"] = "Chi tiết sản phẩm";
    var product = ViewBag.product as Product ?? new Product();
    var relatedProducts = ViewBag.relatedProducts as List<Product> ?? new List<Product>();
}

@section Styles {
    <link rel="stylesheet" href="~/css/product-detail.css">
}

@section Scripts {
    <script>
        const stock = parseInt('@product.Stock');
        const btnAddCart = document.getElementById("btn-add-cart");
        const btnMinus = document.getElementById("minus");
        const btnPlus = document.getElementById("plus");

        document.getElementById("quantity").addEventListener("keyup", function () {
            let quantityInput = document.getElementById("quantity").value;
            let err = document.getElementById("error");
            if (quantityInput > stock) {
                document.getElementById("quantity").value = stock;
            }
            checkQuantity(quantityInput, err);
        });
        btnMinus.addEventListener("click", function () {
            let quantityInput = document.getElementById("quantity").value;
            let err = document.getElementById("error");
            checkQuantity(quantityInput, err);
        });
        btnPlus.addEventListener("click", function () {
            let quantityInput = document.getElementById("quantity").value;
            let err = document.getElementById("error");
            checkQuantity(quantityInput, err);
        });

        function checkQuantity(quantity, err) {
            if (quantity < 1) {
                err.innerHTML = "Số lượng không được nhỏ hơn 1";
                err.style.display = "block";
                btnAddCart.disabled = true;
                btnMinus.disabled = true;
                btnPlus.disabled = false;
            }
            else if (quantity >= stock) {
                err.innerHTML = "Đã đạt giới hạn số lượng tồn kho";
                err.style.display = "block";
                btnAddCart.disabled = true;
                btnPlus.disabled = true;
                btnMinus.disabled = false;
            } else {
                err.style.display = "none";
                btnAddCart.disabled = false;
                btnPlus.disabled = false;
                btnMinus.disabled = false;
            }
        }

        document.getElementById("frm-add-cart").addEventListener("submit", function (e) {
            document.querySelector("input[name=quantity]").value = document.getElementById("quantity").value;
        });
    </script>
}

<!-- Breadcrumb Start -->
<div class="breadcrumb-wrap">
    <div class="container">
        <ul class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
            <li class="breadcrumb-item active">Chi tiết sản phẩm</li>
        </ul>
    </div>
</div>
<!-- Breadcrumb End -->
<!-- Product Detail Start -->
<div class="product-detail">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="product-detail-top">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="product-slider-single normal-slider">
                                @foreach (var p in product.ProductsImages)
                                {
                                    <img src="~/img/products/@p.Image">
                                }
                            </div>
                            <div class="product-slider-single-nav normal-slider">
                                @foreach (var p in product.ProductsImages)
                                {
                                    <div class="slider-nav-img"><img src="~/img/products/@p.Image"></div>
                                }
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="product-content">
                                <div class="title mb-5">
                                    <h2>@product.Name</h2>
                                </div>
                                <div class="info">
                                    <h4>Mã:</h4>
                                    <p>@product.ProductCode</p>
                                </div>
                                <div class="price">
                                    <h4>Giá:</h4>
                                    <p>@Math.Truncate(product.Price * (1 - product.DiscountRate / 100))đ <span style="font-size: 18px;">@Math.Truncate(product.Price)đ</span></p>
                                </div>
                                <div class="info">
                                    <h4>Trạng thái:</h4>
                                    <p>@(product.Stock > 0 ? "còn hàng" : "hết hàng") <span>(@product.Stock)</span></p>
                                </div>
                                <div class="quantity mt-3">
                                    <div class="qty border border-secondary rounded-lg">
                                        <button class="btn-minus rounded-left" id="minus"><i class="fa fa-minus"></i></button>
                                        <input type="text" value="1" id="quantity">
                                        <button class="btn-plus rounded-right" id="plus"><i class="fa fa-plus"></i></button>
                                    </div>
                                    <p id="error" class="text-danger"></p>
                                </div>
                                <div class="d-flex justify-content-between font-weight-bold mb-4">
                                    <div class="flex-grow-1">Lượt bán: <span>20</span></div>
                                    <div class="flex-grow-1">
                                        <i class="fa fa-heart text-danger"></i>
                                        <span>(1121)</span>
                                    </div>
                                    <div class="info flex-grow-1">
                                        <div class="ratting">
                                            <i class="fa fa-star"></i>
                                            <span>(1000)</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="action d-flex ">
                                    <form id="frm-add-cart" asp-controller="Cart" asp-action="AddToCart" method="post">
                                        <input type="hidden" name="quantity" value="" />
                                        <input type="hidden" name="productId" value="@product.Id" />
                                        <div class="btn-add-cart">
                                            <button class="btn btn-outline-info" id="btn-add-cart"><i class="fa fa-shopping-cart"></i> Thêm vào giỏ hàng</button>
                                        </div>
                                    </form>
                                    <a class="btn btn-outline-danger ml-3" asp-controller="Account" asp-action="Index">
                                        <i class="fa fa-heart"></i>Yêu thích
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row product-detail-bottom">
                    <div class="col-lg-12">
                        <ul class="nav nav-pills nav-justified">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="pill" href="#description">Mô tả</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="pill" href="#reviews">Đánh giá (@product.Reviews.Count)</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div id="description" class="container tab-pane active overflow-auto" style="height: 500px;">
                                @Html.Raw(product.Description)
                            </div>
                            <div id="reviews" class="container tab-pane fade">
                                <div class="reviews-submitted overflow-auto" style="max-height: 250px;">
                                    @if (product.Reviews.Count == 0)
                                    {
                                        <p>Hiện tại sản phẩm này chưa có đánh giá nào</p>
                                    }
                                    else
                                    {
                                        @foreach (var r in product.Reviews)
                                        {
                                            <div class="reviewer">@r.Fullname - <span>@r.CreatedAt</span></div>
                                            <p>
                                                @r.Comment
                                            </p>
                                            <div class="ratting">
                                                @for (var i = 1; i <= r.Rating; i++)
                                                {
                                                    <i class="fa fa-star"></i>
                                                }

                                                @for (var i = 1; i <= 5 - r.Rating; i++)
                                                {
                                                    <i class="far fa-star"></i>
                                                }
                                            </div>
                                        }
                                    }
                                </div>
                                <form method="post" asp-controller="Product" asp-action="Comment">
                                    <input type="hidden" name="ProductId" value="@product.Id" />
                                    <div class="reviews-submit">
                                        <h4>Đánh giá của bạn:</h4>
                                        <div class="ratting d-flex justify-content-end flex-row-reverse">
                                            <input type="radio" name="rating" value="5" id="rate-5" />
                                            <label for="rate-5" class="fas fa-star"></label>
                                            <input type="radio" name="rating" value="4" id="rate-4" />
                                            <label for="rate-4" class="fas fa-star"></label>
                                            <input type="radio" name="rating" value="3" id="rate-3" />
                                            <label for="rate-3" class="fas fa-star"></label>
                                            <input type="radio" name="rating" value="2" id="rate-2" />
                                            <label for="rate-2" class="fas fa-star"></label>
                                            <input type="radio" name="rating" value="1" id="rate-1" />
                                            <label for="rate-1" class="fas fa-star"></label>
                                        </div>
                                        <div class="row form">
                                            <div class="col-sm-6">
                                                <input asp-for="Fullname" type="text" placeholder="Họ tên">
                                            </div>
                                            <div class="col-sm-6">
                                                <input asp-for="Email" type="email" placeholder="Email">
                                            </div>
                                            <div class="col-sm-12">
                                                <textarea asp-for="Comment" placeholder="Nội dung đánh giá"></textarea>
                                            </div>
                                            <div class="col-sm-12">
                                                <button class="btn btn-outline-info">Đánh giá</button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Product Detail End -->

@if (relatedProducts.Count > 0)
{
    <div class="product py-3 mb-4">
        <div class="container">
            <div class="section-header">
                <h1>Sản Phẩm Liên Quan</h1>
            </div>
            @await Html.PartialAsync("_ProductSliderPartial", relatedProducts)

        </div>
    </div>
}